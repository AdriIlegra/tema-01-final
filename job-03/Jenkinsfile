pipeline {
    agent any
    environment {
      DOCKERHUB_CREDENTIALS = credentials('dockerhub')
              DOCKERHUB_USERNAME = "${DOCKERHUB_CREDENTIALS_USR}"
              DOCKERHUB_PASSWORD = "${DOCKERHUB_CREDENTIALS_PSW}"
        }

    stages {

        stage('Retrieving WAR file from JFrog Artifactory') {
            steps {
                rtDownload(
                    serverId: "calculadora",
                    spec: """{
                        "files": [
                        {
                            "pattern": "job-01/build/libs/calculator-app.war",
                            "target": "job-02/"
                        }
                        ]
                    } """

                    )
            }
        }

        stage('Construir a Imagem Docker com o Packer') {
                  steps {
                      sh 'packer plugins install github.com/hashicorp/docker'
                      sh 'packer plugins install github.com/hashicorp/ansible'
                      sh 'packer build -var "dockerhub_username=${DOCKERHUB_USERNAME}" -var "dockerhub_password=${DOCKERHUB_PASSWORD}" job-03/packer.json'
                  }
              }

              stage('Enviar a Imagem Docker para o Docker Hub') {
                  steps {
                      sh 'docker login -u ${DOCKERHUB_USERNAME} -p ${DOCKERHUB_PASSWORD}'
                      sh 'docker push adriananogueira/tema_01_final:latest'
                  }
              }
          }
      }

